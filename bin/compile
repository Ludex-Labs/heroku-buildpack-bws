#!/usr/bin/env bash

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output

[ "$BUILDPACK_XTRACE" ] && set -o xtrace

indent() {
  sed -u 's/^/       /'
}

echo "-----> Install BitWarden Secrets Manager CLI" | indent
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

DOWNLOAD_URL="https://github.com/bitwarden/sdk/releases/download/bws-v1.0.0/bws-x86_64-unknown-linux-gnu-1.0.0.zip"
echo "DOWNLOAD_URL = " $DOWNLOAD_URL | indent

# shellcheck source=lib/utils.sh
source "${BP_DIR}/lib/utils.sh"

# Create temp profile directory
mkdir -p "${BP_DIR}/profile"

cd $BUILD_DIR

# Download and unzip the file, with error handling
if ! curl -L --fail $DOWNLOAD_URL -o bws.zip; then
  echo "Failed to download bws" | indent
  exit 1
fi

if ! unzip bws.zip; then
  echo "Failed to unzip bws" | indent
  exit 1
fi

echo "BitWarden CLI installation completed successfully" | indent

if ! "${BUILD_DIR}/bws" --version; then
  echo "Failed to run bws" | indent
  exit 1
fi

if [ ! -f "${ENV_DIR}/BW_ACCESS_TOKEN" ]; then
    echo "BW_ACCESS_TOKEN was not set. Aborting" | indent
    exit 1
fi
BW_ACCESS_TOKEN="$(cat "${ENV_DIR}/BW_ACCESS_TOKEN")"

# Load secrets and export as environment variables, writing to env.sh
"${BUILD_DIR}/bws" secret list --access-token ${BW_ACCESS_TOKEN} \
| grep -E '"key"|"value"' \
| sed -E 's/.*"key": "(.*)",/\1/;s/.*"value": "(.*)"/\1/;s/,$//' \
| awk 'NR%2{key=$0; getline; if (!ENVIRON[key]) printf "export %s=\"%s\"\n", key, $0}' \
> "$BP_DIR/export"

source "$BP_DIR/export"

mkdir -p "$BUILD_DIR/.profile.d"

# Write the environment variables to the env file
# Read the file 'export' and replace each line value by the environment variable key
while IFS= read -r line; do
  # Extract the key from the line
  key=$(echo "$line" | cut -d'=' -f1 | cut -d' ' -f2)
  # Replace the value with the environment variable key
  echo "export $key=\${$key}"
done < "$BP_DIR/export" > "$BUILD_DIR/.profile.d/bws_env.sh"

# Clean up
#rm "${BP_DIR}/export"

echo "BitWarden secrets loaded successfully" | indent
