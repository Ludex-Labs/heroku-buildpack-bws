#!/usr/bin/env bash

set -e  # Exit immediately if a command exits with a non-zero status

indent() {
  sed -u 's/^/       /'
}

echo "-----> Install bws"
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)
DOWNLOAD_URL="https://github.com/bitwarden/sdk/releases/download/bws-v1.0.0/bws-x86_64-unknown-linux-gnu-1.0.0.zip"

echo "DOWNLOAD_URL = " $DOWNLOAD_URL | indent

cd $BUILD_DIR

# Download and unzip the file, with error handling
if ! curl -L --fail $DOWNLOAD_URL -o bws.zip; then
  echo "Failed to download bws" | indent
  exit 1
fi

if ! unzip bws.zip; then
  echo "Failed to unzip bws" | indent
  exit 1
fi

echo "exporting PATH and LIBRARY_PATH" | indent
PROFILE_PATH="$BUILD_DIR/.profile.d/bws.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:$BUILD_DIR/bws/bin"' >> $PROFILE_PATH

echo "bws installation completed successfully" | indent

# Source the profile script to update PATH and LD_LIBRARY_PATH
source $PROFILE_PATH

if ! "${BUILD_DIR}/bws" --version; then
  echo "Failed to run bws" | indent
  exit 1
fi

if [ ! -f "${ENV_DIR}/BW_ACCESS_TOKEN" ]; then
    echo "BW_ACCESS_TOKEN was not set. Aborting" | indent
    exit 1
fi
BW_ACCESS_TOKEN="$(cat "${ENV_DIR}/BW_ACCESS_TOKEN")"

# Load secrets and export as environment variables
"${BUILD_DIR}/bws" secret list --access-token ${BW_ACCESS_TOKEN} \
| grep -E '"key"|"value"' \
| sed -E 's/.*"key": "(.*)",/\1/;s/.*"value": "(.*)"/\1/' \
| awk 'NR%2{printf "if [ -z \"${%s}\" ]; then export %s=", $0, $0; next}1' \
> $BP_DIR/bws_secrets

# Source the generated script to export the variables
source $BP_DIR/bws_secrets

# Delete the secrets file for security
rm -f $BP_DIR/bws_secrets

echo "bws secrets loaded successfully" | indent
