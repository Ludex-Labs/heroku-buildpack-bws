#!/usr/bin/env bash

set -e  # Exit immediately if a command exits with a non-zero status

indent() {
  sed -u 's/^/       /'
}

echo "-----> Install bws"
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)
VENDOR_DIR="vendor"
DOWNLOAD_URL="https://github.com/bitwarden/sdk/releases/download/bws-v1.0.0/bws-x86_64-unknown-linux-gnu-1.0.0.zip"

echo "DOWNLOAD_URL = " $DOWNLOAD_URL | indent

cd $BUILD_DIR
mkdir -p $VENDOR_DIR
cd $VENDOR_DIR

# Download and unzip the file, with error handling
if ! curl -L --fail $DOWNLOAD_URL -o bws.zip; then
  echo "Failed to download bws" | indent
  exit 1
fi

if ! unzip bws.zip; then
  echo "Failed to unzip bws" | indent
  exit 1
fi

echo "exporting PATH and LIBRARY_PATH" | indent
PROFILE_PATH="$BUILD_DIR/.profile.d/bws.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:$BUILD_DIR/vendor/bws/bin"' >> $PROFILE_PATH
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$BUILD_DIR/vendor/bws/lib"' >> $PROFILE_PATH

echo "bws installation completed successfully" | indent

# Source the profile script to update PATH and LD_LIBRARY_PATH
source $PROFILE_PATH

if ! bws --version; then
  echo "Failed to run bws" | indent
  exit 1
fi

if [ ! -f "${ENV_DIR}/BW_ACCESS_TOKEN" ]; then
    echo "BW_ACCESS_TOKEN was not set. Aborting" | indent
    exit 1
fi
BW_ACCESS_TOKEN="$(cat "${ENV_DIR}/BW_ACCESS_TOKEN")"

# Load secrets and export as environment variables
bws secret list --access-token ${BW_ACCESS_TOKEN} | while read -r line; do
  key=$(echo $line | cut -d' ' -f1)
  value=$(echo $line | cut -d' ' -f2-)
  echo "export $key=\"$value\""
done > $BP_DIR/bws_secrets

# Source the generated script to export the variables
source $BP_DIR/bws_secrets

# Delete the secrets file for security
rm -f $BP_DIR/bws_secrets

echo "bws secrets loaded successfully" | indent
